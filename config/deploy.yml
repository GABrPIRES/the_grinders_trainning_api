# config/deploy.yml
service: the-grinders-api
image: gabrielrpires/the_grinders_api

servers:
  web:
    - 68.183.151.132

proxy:
  ssl: true
  host: api.thegrinderspowerlifting.com.br
  app_port: 80
  healthcheck:
    path: /up
    interval: 5

registry:
  username: gabrielrpires
  password:
    - KAMAL_REGISTRY_PASSWORD

# SEU TRUNFO: Usar o servidor para compilar (evita erro de mem√≥ria no Mac e arquitetura)
builder:
  arch: amd64
  remote: ssh://root@68.183.151.132

env:
  secret:
    - RAILS_MASTER_KEY
    - POSTGRES_PASSWORD
    - JWT_SECRET_KEY
    - KAMAL_REGISTRY_PASSWORD
    - SECRET_KEY_BASE
  clear:
    DB_HOST: the-grinders-api-db
    SOLID_QUEUE_IN_PUMA: true
    RAILS_LOG_LEVEL: "info"
    FRONTEND_URL: "https://thegrinderspowerlifting.com.br"

accessories:
  db:
    image: postgres:16
    host: 68.183.151.132
    port: 5432
    env:
      clear:
        POSTGRES_USER: postgres
        POSTGRES_DB: the_grinders_api_production
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data:/var/lib/postgresql/data